#!/bin/sh -x
# /bin/config_secn_aster.sh

# Set up Asterisk config files

# Remove old files
rm /etc/asterisk/potato.sip.conf >> /dev/null
rm /etc/asterisk/potato.extensions.conf >> /dev/null

# Get the parameters from uci config file /etc/config/secn
ENABLE=`uci get secn.asterisk.enable`
REGISTER=`uci get secn.asterisk.register`
USERNAME=`uci get secn.asterisk.username`
FROMUSERNAME=`uci get secn.asterisk.fromusername`

SECRET=`uci get secn.asterisk.secret` # May be empty
SECRET=`echo "$SECRET" | sed -f /bin/url-decode.sed`
uci set secn.accesspoint.secret=$SECRET

HOST=`uci get secn.asterisk.host`
REGHOST=`uci get secn.asterisk.reghost`
#PROXY=`uci get secn.asterisk.proxy`
CODEC1=`uci get secn.asterisk.codec1`
CODEC2=`uci get secn.asterisk.codec2`
CODEC3=`uci get secn.asterisk.codec3`
DIALOUT=`uci get secn.asterisk.dialout`
ENABLENAT=`uci get secn.asterisk.enablenat`
EXTERNIP=`uci get secn.asterisk.externip`
SOFTPH=`uci get secn.asterisk.softph`

# Get localnet and netmask from br-lan settings
LOCALNET=`uci get network.lan.ipaddr | awk -F. '{print $1"."$2"."$3"."0}'`
LOCALNETMASK=`uci get network.lan.netmask`

# Get Asterisk SIP settings
if [ $ENABLE = "checked" ]; then
ENFLAG=" "
else
ENFLAG=";"
fi

if [ $REGISTER = "checked" ]; then
REGFLAG=" "
else
REGFLAG=";"
fi

if [ $ENABLENAT = "checked" ]; then
ENABLENATFLAG=" "
else
ENABLENATFLAG=";"
fi

# Check whether device is already at Softphone Master IP address
CURRENTOCTET4=`uci get network.lan.ipaddr | cut -d = -f 2 | cut -d . -f 4`

# If so, set new IP addr to default of .20 in case device is made non-Master
# and the user forgets to change the IP address in the web UI at the same time

if [ $CURRENTOCTET4 = "252" ]; then
OCTET4="20"
else
# Otherwise, use the current IP address
OCTET4="$CURRENTOCTET4"
fi

if [ $SOFTPH = "OFF" ]; then
SOFTPHFLAG=";"
SOFTPHMASTER=";"
SOFTPHCLIENT=";"
fi

if [ $SOFTPH = "CLIENT" ]; then
SOFTPHFLAG=" "
SOFTPHMASTER=";"
SOFTPHCLIENT=" "
fi

if [ $SOFTPH = "MASTER" ]; then
SOFTPHFLAG=" "
SOFTPHMASTER=" "
SOFTPHCLIENT=";"
# Default Softphone Master IP is <subnet>.252
OCTET4="252"
fi

# Set up the default Softphone Master IP address 
OCTET123=`uci get network.lan.ipaddr | cut -d = -f 2 | cut -d . -f 1,2,3`
# Default Softphone Master IP is .252
SOFTPHMASTERIP=$OCTET123.252

# Set up new device IP
DEVICEIP=$OCTET123.$OCTET4
uci set network.lan.ipaddr=$DEVICEIP

#--------------------------------------------

# Create new Asterisk 'potato.sip.conf' include file
# Everything from here to EOF will be written to the file
cat > /etc/asterisk/potato.sip.conf << EOF

;-------------------------------
; /etc/asterisk/potato.sip.conf
; -----------------------------
; Config for SIP host [sipaccount] and Softphone calls
; CAUTION: This file is automatically generated by script /etc/init.d/config_secn
; Do not edit this file manually on a running system
; See /etc/config/secn for config parameters

; SIP host calls
; Configure for NAT if required
$ENABLENATFLAG localnet=$LOCALNET/$LOCALNETMASK                     
$ENABLENATFLAG externip=$EXTERNIP 

; Register to VoIP Provider
$REGFLAG $ENFLAG register => $USERNAME:$SECRET@$REGHOST

[sipaccount]
$ENFLAG host=$HOST
$ENFLAG secret=$SECRET
$ENFLAG defaultuser=$USERNAME
$ENFLAG fromuser=$USERNAME
$ENFLAG fromdomain=$REGHOST

insecure=port,invite
type=friend
disallow=all
allow=$CODEC1,$CODEC2,$CODEC3
dtmfmode=rfc2833
qualify=yes
canreinvite=nonat
context=incoming-vsp
alwaysauthreject=yes
;----------------------------

; Softphone support include file
;-------------------------------
; Defines softphone extensions.
$SOFTPHFLAG #include "softphone.sip.conf"
;-------------------------------

EOF
#-----------------------------------------------------------

# Create 'potato.extensions.conf' include file

# Set up for Auto dialout for six or more digits
if [ $DIALOUT == "Auto" ]; then
		DIALOUT="XXXXX"
    Y=0
else
    Y=1
fi

# Everything from here to EOF will be written to the file

cat > /etc/asterisk/potato.extensions.conf << EOF

;----------------------------------------------
; /etc/asterisk/potato.extensions.conf
; ---------------------------------------------

; Dialplan to support outgoing calls
; CAUTION: This is an automatically generated file by script /etc/init.d/config_secn
; Do not edit this file manually on a running system
; See /etc/config/secn for config parameters

; Make calls using a SIP host [sipaccount] 
; Dial <DIALOUT> digit for access, and then required number string.
; If DIALOUT is Auto, dial strings of six or more digits will match. 

[outgoing-vsp]
exten => _$DIALOUT.,1,Dial(SIP/\${EXTEN:$Y}@sipaccount,120,r)

; Make calls to Softphone extensions 
; Device is Softphone Master (SIP server) or Client (only if FXS present e.g. MP)
; For the Master device
[outgoing-softphone]
$SOFTPHMASTER exten => _3XX,1,Dial(SIP/softph\${EXTEN})

; For the Client device
$SOFTPHCLIENT exten => _3XX,1,Dial(SIP/\${EXTEN}@$SOFTPHMASTERIP, 120, r)

;-------------------------------

EOF
# ------------------------------------------------------------------

# Make sure Asterisk custom include files exist for user defined functions.
touch /etc/asterisk/custom.incoming.extensions.conf
touch /etc/asterisk/custom.extensions.conf
touch /etc/asterisk/custom.sip.conf
# -----------------------------------------------------

# Save the changes 
uci commit network
uci commit secn

